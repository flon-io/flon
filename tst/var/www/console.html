
<!DOCTYPE HTML>

<html>
  <head>
    <title>flon</title>
    <link href="css/flon.css" rel="stylesheet" />
  </head>

  <body>

    <div id="header">
        <div class="logo">
          <a href="http://flon.io?console=1" target="_blank">
            <img src="images/flon_io.png" />
            <span>flon</span>
          </a>
        </div>
    </div>

    <div class="panes">

      <div class="left-pane">

        <div class="tabs">
          <div id="postFormTab" class="tab selected">post</div>
          <div id="executionsTab" class="tab">executions</div>
          <div id="inspectorTab" class="tab">inspect</div>
        </div>

        <div id="postForm" class="sub-pane">
          <h2>post to /i/in</h2>
          <p>
            <textarea id="inField">
            </textarea>
            <input id="inSubmit" type="submit" />
          </p>
        </div>

        <div id="executions" class="sub-pane">
          <h2>executions</h2>
          <input id="executionsRefresh" type="submit" value="refresh" />
          <div id="executionList"></div>
        </div>

        <div id="inspector" class="sub-pane">
          <h2>inspect something</h2>
          <iframe id="inspFrame" src="">
          </iframe>
        </div>
      </div>

      <div class="right-pane">

        <div id="log">
          <div><!-- placeholder --></div>
        </div>
      </div>
    </div>

    <script src="js/handlebars.js"></script>
    <script src="js/flon.js"></script>

    <script>

      var RELS = "http://flon.io/rels.html";

      function xhrefClick(e)
      {
        var xhref = e.target.getAttribute('xhref');
        byid('inspFrame').setAttribute('src', xhref);
        byid('inspectorTab').click();
      }

      function enableXhref(e)
      {
        if ( ! e.getAttribute('xhref')) return;
        e.removeEventListener('click', xhrefClick);
        e.addEventListener('click', xhrefClick);
      }

      function onError(e)
      {
        console.log(e);

        var msg = {}
        msg.tstamp = tstamp();
        msg.code = 0;
        msg.message = '' + e;

        var html = postFailureTemplate(msg);

        byid('log').children[0].insertAdjacentHTML('beforebegin', html);
      }

      function inOnLoad(e)
      {
        var t = e.target;
        var html = null;

        if (t.status === 200)
        {
          var msg = JSON.parse(t.responseText);
          msg.code = t.status;
          msg.href = msg._links[RELS + '#execution'];

          html = postSuccessTemplate(msg);
        }
        else
        {
          var msg = {}
          msg.tstamp = tstamp();
          msg.code = t.status;
          msg.message = t.responseText;

          html = postFailureTemplate(msg);
        }

        //console.log(msg);
        byid('log').children[0].insertAdjacentHTML('beforebegin', html);
        bytag(byid('log'), 'a').forEach(enableXhref);
      }

      function inSubmit()
      {
        var req = new XMLHttpRequest();
        req.open('POST', './i/in', true);
        req.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');
        req.onerror = onError;
        req.onload = inOnLoad;
        req.send(document.getElementById("inField").value);
      }

      function refreshOnLoad(e)
      {
        //console.log(e.target.responseText);
        var j = JSON.parse(e.target.responseText);
        var list = byid("executionList");
        j._embedded.executions.forEach(function(e)
        {
          var el = document.createElement('div');
          el.innerHTML = executionEntryTemplate(e);
          list.appendChild(el);
        });
        bytag(list, 'a').forEach(enableXhref);
      }

      function refreshExecutions()
      {
        byid("executionList").innerHTML = '';
        var req = new XMLHttpRequest();
        req.open('GET', './i/executions', true);
        req.onerror = onError;
        req.onload = refreshOnLoad;
        req.send();
      }

      function onTabClick(e)
      {
        byclass("tab").forEach(function(e) { e.classList.remove('selected'); });
        e.target.classList.add('selected');

        byclass("sub-pane").forEach(function(e) { e.style.display = 'none' });
        byid(e.target.id.slice(0, -3)).style.display = 'block';
      }

      var postAnswerTemplate = null;
      var postFailureTemplate = null;
      var executionEntryTemplate = null;

      document.addEventListener('DOMContentLoaded', function() {

        byclass("tab").forEach(function(e) {
          e.addEventListener('click', onTabClick);
        });

        byid("inSubmit").addEventListener('click', inSubmit);
        byid("executionsRefresh").addEventListener('click', refreshExecutions);

        byid("inField").textContent = byid("launchJson").textContent;
        byid("postForm").style.display = 'block';


        postSuccessTemplate =
          Handlebars.compile(byid("postSuccessTemplate").innerHTML);
        postFailureTemplate =
          Handlebars.compile(byid("postFailureTemplate").innerHTML);
        executionEntryTemplate =
          Handlebars.compile(byid("executionEntryTemplate").innerHTML);
      });
    </script>

    <div id="launchJson" class="hidden">
{
  domain: org.example
  execute:
    [ sequence, {}, [
      [ invoke, { _0: stamp, color: red }, [] ]
      [ invoke, { _0: stamp, color: green }, [] ]
      [ invoke, { _0: stamp, color: blue }, [] ]
      [ invoke, { _0: null }, [] ]
    ] ]
  payload: {
    hello: world
  }
}
    </div>

    <div id="postSuccessTemplate" class="hidden">
      <div>
        {{ tstamp }} -
        {{ message }} -
        <a href="#" xhref="{{ href }}">{{ exid }}</a>
      </div>
    </div>
    <div id="postFailureTemplate" class="hidden">
      <div>
        {{ tstamp }} -
        {{ code }} -
        {{ message }}
      </div>
    </div>
    <div id="executionEntryTemplate" class="hidden">
      <div>
        <a href="#" xhref="{{ _links.self.href }}">{{ exid }}</a>
      </div>
    </div>
  </body>
</html>

